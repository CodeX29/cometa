<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cometa | –°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å–µ—Ç—å</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

    <header>
        <div class="logo">Cometa üå†</div>
        <div class="user-info" id="userInfo">–ì–æ—Å—Ç—å</div>
    </header>

    <main>
        <div class="create-post">
            <input type="text" id="username" placeholder="–¢–≤–æ–µ –∏–º—è" maxlength="20">
            <textarea id="postInput" placeholder="–û —á–µ–º –¥—É–º–∞–µ—à—å, –ø—É—Ç–Ω–∏–∫?"></textarea>
            <button onclick="addPost()" id="publishBtn">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            <div id="status"></div>
        </div>

        <div class="feed" id="feed">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...</div>
        </div>
    </main>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // üî• –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–ô firebaseConfig –ò–ó –ö–û–ù–°–û–õ–ò FIREBASE üî•
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyCPk-RhF1sCezr6uuU0UUXbeeJilkNCwYQ",
          authDomain: "cometa-network.firebaseapp.com",
          projectId: "cometa-network",
          storageBucket: "cometa-network.firebasestorage.app",
          messagingSenderId: "781909887784",
          appId: "1:781909887784:web:291dbff463adbdf6bd9e1d",
          measurementId: "G-94JT37858S"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è HTML
        window.addPost = async function() {
            const username = document.getElementById('username').value.trim();
            const text = document.getElementById('postInput').value.trim();
            const status = document.getElementById('status');
            const btn = document.getElementById('publishBtn');

            if (!username) {
                status.textContent = "‚ö†Ô∏è –í–≤–µ–¥–∏ –∏–º—è!";
                status.style.color = "#ff6b6b";
                return;
            }

            if (!text) {
                status.textContent = "‚ö†Ô∏è –ü–æ—Å—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!";
                status.style.color = "#ff6b6b";
                return;
            }

            btn.disabled = true;
            btn.textContent = "–ü—É–±–ª–∏–∫–∞—Ü–∏—è...";

            try {
                await addDoc(collection(db, "posts"), {
                    username: username,
                    text: text,
                    timestamp: serverTimestamp()
                });

                document.getElementById('postInput').value = "";
                status.textContent = "‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!";
                status.style.color = "#51cf66";
            } catch (error) {
                status.textContent = "‚ùå –û—à–∏–±–∫–∞: " + error.message;
                status.style.color = "#ff6b6b";
            }

            btn.disabled = false;
            btn.textContent = "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å";
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
        
        onSnapshot(q, (snapshot) => {
            const feed = document.getElementById('feed');
            feed.innerHTML = "";
            
            snapshot.forEach((doc) => {
                const post = doc.data();
                const date = post.timestamp ? new Date(post.timestamp.toDate()).toLocaleString() : "–¢–æ–ª—å–∫–æ —á—Ç–æ";
                
                const postElement = document.createElement('div');
                postElement.classList.add('post');
                postElement.innerHTML = `
                    <div class="post-author">@${post.username}</div>
                    <div class="post-date">${date}</div>
                    <div class="post-content">${post.text}</div>
                `;
                feed.appendChild(postElement);
            });
        });
    </script>
</body>
</html>
