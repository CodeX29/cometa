<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cometa | –°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å–µ—Ç—å</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

    <header>
        <div class="logo">Cometa üå†</div>
        <div class="user-info" id="userInfo">–ì–æ—Å—Ç—å</div>
    </header>

    <main>
        <div class="create-post">
            <input type="text" id="username" placeholder="–¢–≤–æ–µ –∏–º—è" maxlength="20">
            <textarea id="postInput" placeholder="–û —á–µ–º –¥—É–º–∞–µ—à—å, –ø—É—Ç–Ω–∏–∫?"></textarea>
            <button onclick="addPost()" id="publishBtn">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            <div id="status"></div>
        </div>

        <div class="feed" id="feed">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...</div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, increment, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // üî• –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–ô firebaseConfig –ò–ó –ö–û–ù–°–û–õ–ò FIREBASE üî•
        const firebaseConfig = {
            apiKey: "AIzaSy...",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ localStorage (—á—Ç–æ–±—ã –Ω–µ –≤–≤–æ–¥–∏—Ç—å –∫–∞–∂–¥—ã–π —Ä–∞–∑)
        let currentUser = localStorage.getItem('cometaUsername') || '';
        document.getElementById('username').value = currentUser;

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
        document.getElementById('username').addEventListener('change', (e) => {
            currentUser = e.target.value.trim();
            localStorage.setItem('cometaUsername', currentUser);
        });

        window.addPost = async function() {
            const username = document.getElementById('username').value.trim();
            const text = document.getElementById('postInput').value.trim();
            const status = document.getElementById('status');
            const btn = document.getElementById('publishBtn');

            if (!username) {
                status.textContent = "‚ö†Ô∏è –í–≤–µ–¥–∏ –∏–º—è!";
                status.style.color = "#ff6b6b";
                return;
            }

            if (!text) {
                status.textContent = "‚ö†Ô∏è –ü–æ—Å—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!";
                status.style.color = "#ff6b6b";
                return;
            }

            btn.disabled = true;
            btn.textContent = "–ü—É–±–ª–∏–∫–∞—Ü–∏—è...";

            try {
                await addDoc(collection(db, "posts"), {
                    username: username,
                    text: text,
                    timestamp: serverTimestamp(),
                    likes: 0,
                    likedBy: []
                });

                document.getElementById('postInput').value = "";
                status.textContent = "‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!";
                status.style.color = "#51cf66";
            } catch (error) {
                status.textContent = "‚ùå –û—à–∏–±–∫–∞: " + error.message;
                status.style.color = "#ff6b6b";
            }

            btn.disabled = false;
            btn.textContent = "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å";
        };

        // –§—É–Ω–∫—Ü–∏—è –ª–∞–π–∫–∞
        window.toggleLike = async function(postId, currentLikes, likedBy) {
            if (!currentUser) {
                alert("‚ö†Ô∏è –í–≤–µ–¥–∏ —Å–≤–æ—ë –∏–º—è, —á—Ç–æ–±—ã —Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫–∏!");
                return;
            }

            const postRef = doc(db, "posts", postId);
            
            if (likedBy.includes(currentUser)) {
                // –£–±—Ä–∞—Ç—å –ª–∞–π–∫
                await updateDoc(postRef, {
                    likes: increment(-1),
                    likedBy: arrayRemove(currentUser)
                });
            } else {
                // –ü–æ—Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫
                await updateDoc(postRef, {
                    likes: increment(1),
                    likedBy: arrayUnion(currentUser)
                });
            }
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤
        const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
        
        onSnapshot(q, (snapshot) => {
            const feed = document.getElementById('feed');
            feed.innerHTML = "";
            
            if (snapshot.empty) {
                feed.innerHTML = '<div class="loading">–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤. –ë—É–¥—å –ø–µ—Ä–≤—ã–º! üå†</div>';
                return;
            }
            
            snapshot.forEach((doc) => {
                const post = doc.data();
                const date = post.timestamp ? new Date(post.timestamp.toDate()).toLocaleString() : "–¢–æ–ª—å–∫–æ —á—Ç–æ";
                const isLiked = post.likedBy && post.likedBy.includes(currentUser);
                
                const postElement = document.createElement('div');
                postElement.classList.add('post');
                postElement.innerHTML = `
                    <div class="post-header">
                        <div class="post-author">@${post.username}</div>
                        <div class="post-date">${date}</div>
                    </div>
                    <div class="post-content">${post.text}</div>
                    <div class="post-actions">
                        <button class="like-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${doc.id}', ${post.likes || 0}, ${JSON.stringify(post.likedBy || [])})">
                            ${isLiked ? '‚ù§Ô∏è' : 'ü§ç'} <span class="like-count">${post.likes || 0}</span>
                        </button>
                    </div>
                `;
                feed.appendChild(postElement);
            });
        });
    </script>
</body>
</html>
